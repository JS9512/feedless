-- feature
DROP TABLE t_feature;
DROP TABLE t_plan;
DROP TABLE t_product;
DROP TABLE t_feature_value;

-- user

ALTER TABLE t_user
  RENAME COLUMN createdat to created_at;
ALTER TABLE t_user
  RENAME COLUMN approvedtermsat to approved_terms_at;
ALTER TABLE t_user
  RENAME COLUMN isroot to is_root;
ALTER TABLE t_user
  RENAME COLUMN locked to is_locked;
ALTER TABLE t_user
  RENAME COLUMN purgescheduledfor to purge_scheduled_for;

ALTER TABLE IF EXISTS t_user DROP COLUMN IF EXISTS name;

ALTER TABLE IF EXISTS t_user DROP COLUMN IF EXISTS notifications_stream_id;

ALTER TABLE IF EXISTS t_user DROP COLUMN IF EXISTS plugins;

ALTER TABLE IF EXISTS t_user
  ALTER COLUMN email DROP NOT NULL;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN githubid character varying(255);

ALTER TABLE IF EXISTS t_user
  ADD COLUMN has_validated_email boolean NOT NULL DEFAULT FALSE;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN is_anonymous boolean NOT NULL DEFAULT FALSE;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN is_banned boolean NOT NULL DEFAULT FALSE;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN is_banned_until timestamp(6) without time zone;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN is_shaddow_banned boolean NOT NULL DEFAULT FALSE;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN is_spamming_submissions boolean NOT NULL DEFAULT FALSE;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN is_spamming_votes boolean NOT NULL DEFAULT FALSE;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN karma integer NOT NULL DEFAULT 10;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN last_login timestamp(6) without time zone;

ALTER TABLE IF EXISTS t_user
  ADD COLUMN product smallint NOT NULL DEFAULT 'rssProxy';

ALTER TABLE IF EXISTS t_user
  ADD COLUMN validated_email_at timestamp(6) without time zone;
ALTER TABLE IF EXISTS t_user
  ADD CONSTRAINT uniqueuser UNIQUE (email, product);
ALTER TABLE IF EXISTS t_user DROP CONSTRAINT IF EXISTS fk5t89sip0n4g578g4yxaugjc1h;

-- repository
ALTER TABLE t_bucket
  RENAME TO t_repository;

ALTER TABLE IF EXISTS t_repository DROP COLUMN IF EXISTS imageurl;

ALTER TABLE IF EXISTS t_repository DROP COLUMN IF EXISTS streamid;

ALTER TABLE IF EXISTS t_repository DROP COLUMN IF EXISTS tags;

ALTER TABLE IF EXISTS t_repository DROP COLUMN IF EXISTS webhookurl;

ALTER TABLE IF EXISTS t_repository DROP COLUMN IF EXISTS websiteurl;


ALTER TABLE t_repository
  RENAME COLUMN createdat to created_at;

ALTER TABLE t_repository
  RENAME COLUMN ownerid to owner_id;

ALTER TABLE t_repository
  RENAME COLUMN lastupdatedat to last_updated_at;

ALTER TABLE t_repository
  ALTER COLUMN title TYPE character varying(50);

ALTER TABLE t_repository
  ALTER COLUMN visibility TYPE character varying(50);

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN type character varying(31) NOT NULL DEFAULT '';

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN is_archived boolean NOT NULL DEFAULT false;

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN disabled_from timestamp(6) without time zone;

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN document_count_since_creation integer;

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN plugins jsonb NOT NULL DEFAULT '{}';

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN for_product smallint NOT NULL DEFAULT 2;

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN retention_max_age_days integer;

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN retention_max_items integer;

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN segmentation_id uuid;

-- scheduler cron
ALTER TABLE IF EXISTS t_repository
  ADD COLUMN scheduler_expression character varying(255);
UPDATE t_repository set scheduler_expression = '0 0 */12 * * *';
ALTER TABLE IF EXISTS t_repository
  ALTER COLUMN scheduler_expression SET NOT NULL;
--

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN sunset_after timestamp(6) without time zone;

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN sunset_after_total_document_count integer;

ALTER TABLE IF EXISTS t_repository
  ADD COLUMN trigger_scheduled_next_at timestamp(6) without time zone;

ALTER TABLE IF EXISTS t_repository
  RENAME CONSTRAINT t_bucket_pkey TO t_repository_pkey;
ALTER TABLE IF EXISTS t_repository DROP CONSTRAINT IF EXISTS fk157cu4wjd97imxmg4ns0x3x85;

ALTER TABLE IF EXISTS t_repository DROP CONSTRAINT IF EXISTS fkhr17e39pk9333v21m3ha23ggl;

ALTER TABLE IF EXISTS t_repository
  ADD CONSTRAINT fkcxaqh74vklfwnfrxaa0jmix4i FOREIGN KEY (owner_id)
    REFERENCES t_user (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;




-- after segment
ALTER TABLE IF EXISTS t_repository
  ADD CONSTRAINT fk1bvl5tll4isnaxnyjqq1shtld FOREIGN KEY (segmentation_id)
    REFERENCES t_segment (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


---


-- -----

ALTER TABLE t_feed_native
  RENAME TO t_source;

ALTER  TABLE t_article DROP constraint fk5a2eyi09un1yg3xls70asf5va;
ALTER  TABLE t_hyperlink DROP constraint fkgd7hbkkhrefq82vngp00so06d;
ALTER  TABLE t_hyperlink DROP constraint fkixc22j33g4ov6eskdww7884ci;
DROP TABLE t_web_document;
DROP TABLE t_article;
DROP TABLE t_hyperlink;

-- source
ALTER TABLE t_source
  RENAME COLUMN createdat to created_at;

ALTER TABLE t_source
  RENAME COLUMN feedurl to url;

-- cause: native feeds keep the default
ALTER TABLE IF EXISTS t_source
  ADD COLUMN emit jsonb NOT NULL default '[{"imageBased": null, "selectorBased": {"max": null, "min": null, "xpath": {"value": "/"}, "expose": {"pixel": null, "fields": null, "transformers": [{"params": {"jsonData": null, "org_feedless_feed": null, "org_feedless_filter": null, "org_feedless_fulltext": null, "org_feedless_conditional_tag": null, "org_feedless_diff_email_forward": null}, "pluginId": "org_feedless_feed"}]}}}]';

UPDATE t_source S
  SET emit = (SELECT '[{"imageBased": null, "selectorBased": {"max": null, "min": null, "xpath": {"value": "/"}, "expose": {"pixel": null, "fields": null, "transformers": [{"params": {"jsonData": null, "org_feedless_feed": ' || feedspecification || '"org_feedless_filter": null, "org_feedless_fulltext": null, "org_feedless_conditional_tag": null, "org_feedless_diff_email_forward": null}, "pluginId": "org_feedless_feed"}]}}}]' from t_feed_generic G where S.generic_feed_id = G.id),
      url = (SELECT websiteurl from t_feed_generic G where S.generic_feed_id = G.id)
  WHERE S.generic_feed_id is not null
