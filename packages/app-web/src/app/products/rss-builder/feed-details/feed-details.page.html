<ion-header *ngIf="repository?.disabledFrom">
  <ion-toolbar color="danger">
    <ion-text style="font-size: 16px" class="ion-padding-horizontal"
      >This feed will expire in
      <strong>{{fromNow(repository.disabledFrom)}}</strong></ion-text
    >
    <ion-button
      slot="end"
      color="light"
      class="ion-margin-horizontal"
      shape="round"
    >
      Remove Expiry
    </ion-button>
  </ion-toolbar>
</ion-header>
<ion-header *ngIf="repository?.archived">
  <ion-toolbar color="medium">
    <ion-text style="font-size: 16px" class="ion-padding-horizontal">
      Feed is archived. It will not be updated.
    </ion-text>
    <ion-button
      slot="end"
      color="light"
      class="ion-margin-horizontal"
      shape="round"
    >
      Resume
    </ion-button>
  </ion-toolbar>
</ion-header>
<ion-content class="ion-padding">
  <div class="limited-width-pane">
    <ion-breadcrumbs>
      <ion-breadcrumb routerLink="/">Home</ion-breadcrumb>
      <ion-breadcrumb routerLink="/feeds">Feeds</ion-breadcrumb>
      <ion-breadcrumb>{{ repository?.title }}</ion-breadcrumb>
    </ion-breadcrumbs>

    <div *ngIf="busy">
      <ion-spinner name="dots"></ion-spinner>
    </div>

    <div *ngIf="errorMessage">
      <ion-item color="danger">
        <p>{{errorMessage}}</p>
      </ion-item>
    </div>

    <div *ngIf="!busy && !errorMessage" style="margin-top: 50px">
      <ion-row>
        <ion-col size="6">
          <h2 class="ion-no-margin" style="display: inline">
            {{ repository.title }}
          </h2>
          <ion-chip
            (click)="editRepository()"
            *ngIf="repository.visibility === GqlVisibility.IsPrivate"
            >Private</ion-chip
          >
        </ion-col>
        <ion-col size="6">
          <ion-toolbar style="--background: transparent">
            <ion-buttons slot="end">
              <!--              <ion-button [href]="feedUrl">-->
              <!--                <ion-icon name="notifications-outline" slot="start"></ion-icon>-->
              <!--                Notifications-->
              <!--              </ion-button>-->

              <!--              <ion-button [href]="feedUrl">-->
              <!--&lt;!&ndash;                <ion-icon name="notifications-outline" slot="start"></ion-icon>&ndash;&gt;-->
              <!--                Pulls-->
              <!--                <ion-chip>231</ion-chip>-->
              <!--              </ion-button>-->

              <ion-button [href]="feedUrl" color="primary" fill="solid">
                <ion-icon name="logo-rss" slot="start"></ion-icon>
                Feed
              </ion-button>

              <ion-button id="open-settings-modal" color="dark" fill="clear">
                <ion-icon name="ellipsis-vertical-outline"></ion-icon>
                <app-bubble *ngIf="hasErrors()" color="red"></app-bubble>
              </ion-button>

              <ion-popover
                [showBackdrop]="false"
                trigger="open-settings-modal"
                triggerAction="click"
              >
                <ng-template>
                  <ion-content>
                    <ion-list>
                      <ion-modal trigger="open-sources-modal">
                        <ng-template>
                          <ion-header>
                            <ion-toolbar>
                              <ion-buttons slot="start">
                                <ion-button (click)="dismissModal()">
                                  <ion-icon name="close-outline"></ion-icon>
                                </ion-button>
                              </ion-buttons>
                              <ion-title>Sources</ion-title>
                              <ion-buttons slot="end">
                                <!--          <ion-button (click)="confirm()" [strong]="true">Confirm</ion-button>-->
                                <ion-button
                                  color="primary"
                                  fill="solid"
                                  (click)="editSource()"
                                  >Add Source</ion-button
                                >
                              </ion-buttons>
                            </ion-toolbar>
                          </ion-header>
                          <ion-content class="ion-padding">
                            <ion-list>
                              <ion-item *ngIf="repository.sources.length === 0">
                                <ion-label color="danger"
                                  >No sources defined</ion-label
                                >
                              </ion-item>
                              <ion-item
                                *ngFor="let source of repository.sources"
                              >
                                <app-bubble
                                  [color]="getHealthColorForSource(source)"
                                ></app-bubble>
                                <ion-label>
                                  <h3>From {{source.page.url}}</h3>
                                  <p>{{getPluginsOfSource(source)}}</p>
                                  <ion-note
                                    color="danger"
                                    *ngIf="source.errornous"
                                  >
                                    {{source.lastErrorMessage}}
                                  </ion-note>
                                </ion-label>
                                <ion-buttons>
                                  <ion-button
                                    color="danger"
                                    (click)="deleteSource(source)"
                                  >
                                    Delete
                                  </ion-button>
                                  <ion-button (click)="editSource(source)">
                                    Edit
                                  </ion-button>
                                </ion-buttons>
                              </ion-item>
                            </ion-list>
                          </ion-content>
                        </ng-template>
                      </ion-modal>
                      <ion-item id="open-sources-modal" button="true">
                        <ion-icon
                          name="git-branch-outline"
                          slot="start"
                        ></ion-icon>
                        <ion-label>
                          Sources
                          <app-bubble
                            *ngIf="hasErrors()"
                            color="red"
                            slot="end"
                          ></app-bubble>
                        </ion-label>
                        <ion-chip *ngIf="!hasErrors()"
                          >{{repository.sources.length}}</ion-chip
                        >
                      </ion-item>
                      <ion-item button="true" (click)="editRepository()">
                        <ion-icon
                          name="settings-outline"
                          slot="start"
                        ></ion-icon>
                        <ion-label>Edit </ion-label>
                      </ion-item>
                      <ion-item button="true" (click)="deleteRepository()">
                        <ion-icon name="trash-outline" slot="start"></ion-icon>
                        <ion-label>Delete </ion-label>
                      </ion-item>
                    </ion-list>
                  </ion-content>
                </ng-template>
              </ion-popover>
            </ion-buttons>
          </ion-toolbar>
        </ion-col>
      </ion-row>
      <div
        class="description"
        [ngClass]="{'description--flat': !showFullDescription}"
        (click)="showFullDescription = true"
      >
        <ion-row>
          <ion-col>
            <strong>Description</strong>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col> {{ repository.description }} </ion-col>
        </ion-row>
        <ion-row>
          <ion-col>
            <dl>
              <dt>Filters</dt>
              <dd>{{getPluginsOfSubscription(repository)}}</dd>
              <dt>Created</dt>
              <dd>{{ repository.createdAt | date: dateFormat }}</dd>
              <dt>Last Updated</dt>
              <dd>{{ fromNow(repository.lastUpdatedAt) }} ago</dd>
              <dt>Next Updated</dt>
              <dd>{{ fromNow(repository.nextUpdateAt) }}</dd>
              <dt>Retention Strategy</dt>
              <dd>{{ getRetentionStrategy() }}</dd>
            </dl>
          </ion-col>
        </ion-row>
      </div>
      <!--      <div style="position: relative">-->
      <!--        <app-histogram [data]="repository.activity"></app-histogram>-->
      <!--      </div>-->

      <div style="border-radius: 8px">
        <!--        <ion-toolbar>-->
        <!--          <ion-buttons slot="end">-->
        <!--            <ion-button color="dark"-->
        <!--                        [fill]="showFullArticle ? undefined : 'solid'"-->
        <!--                        (click)="showFullArticle = !showFullArticle">Preview</ion-button>-->
        <!--            <ion-button color="primary"-->
        <!--                        [fill]="showFullArticle ? 'solid' : undefined"-->
        <!--                        (click)="showFullArticle = !showFullArticle">Full</ion-button>-->
        <!--            <ion-text>|</ion-text>-->
        <!--            <ion-button color="primary" (click)="showImages = !showImages" fill="solid">-->
        <!--              <ion-icon name="image-outline"></ion-icon>-->
        <!--            </ion-button>-->
        <!--          </ion-buttons>-->
        <!--        </ion-toolbar>-->

        <div *ngIf="hasDevProfile()">
          <ion-segment
            [(ngModel)]="renderText"
            mode="ios"
            style="max-width: 200px; margin: auto"
          >
            <ion-segment-button [value]="true">
              <ion-label>Text</ion-label>
            </ion-segment-button>
            <ion-segment-button [value]="false">
              <ion-label>HTML</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <ion-item *ngIf="pages.length === 0 || pages[0].length === 0">
          <ion-label> Feed has no items.</ion-label>
        </ion-item>

        <ng-container *ngFor="let documents of pages">

          <div *ngFor="let document of documents" class="document">
            <div>{{fromNow(document.publishedAt)}} ago</div>
            <h4>
              <a
                [href]="document.url"
                target="_blank"
                referrerpolicy="no-referrer"
                >{{document.contentTitle}}</a
              >
            </h4>
            <p>on {{hostname(document.url)}}</p>

            <div class="content" *ngIf="renderText">
              {{document.contentText}}
            </div>
            <app-reader
              *ngIf="!renderText"
              [html]="document.contentHtml"
              [showImages]="showImages"
              style="font-size: 1.1rem; line-height: 1.3rem"
            ></app-reader>
          </div>
        </ng-container>

        <div style="text-align: center">
          <ion-button
            color="primary"
            (click)="loadMore()"
            *ngIf="!hasEndReached()"
            >Load older items</ion-button
          >
        </div>
        <!--        <ion-infinite-scroll (ionInfinite)="loadMore($event)">-->
        <!--          <ion-infinite-scroll-content></ion-infinite-scroll-content>-->
        <!--        </ion-infinite-scroll>-->
      </div>
    </div>
  </div>
</ion-content>
