<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="closeModal()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Builder</ion-title>
    <ion-button slot="end" color="primary" (click)="build()">
      Save
    </ion-button>
  </ion-toolbar>
</ion-header>
<ion-content>
  <div class="flex__column ion-margin-horizontal">
    <ion-row>
      <ion-col size="2">
        SELECT
      </ion-col>
      <ion-col size="10">
        <div class="builder-group">
          <div class="builder-group--blocks">
            <div *ngFor="let outputType of builder.select.pickedOptions()">
              <app-menu (valueChanged)="builder.select.drop(outputType)"
                        [hideFilter]="true"
                        [options]="['Delete']">
                {{ outputType.label }}
              </app-menu>
            </div>
            <div>
              <app-menu *ngIf="builder.select.hasOptions()"
                        [labelFn]="'label'"
                        (valueChanged)="builder.select.pick($event)"
                        [options]="builder.select.availableOptions()">
                <ion-icon name="add-outline"></ion-icon>
              </app-menu>
            </div>
<!--            <div>-->
<!--              <ion-button color="primary" fill="clear">AS</ion-button>-->
<!--            </div>-->
          </div>
          <div class="builder-group--right">
            <ion-note>{{ builder.select.output().join(', ') }}</ion-note>
          </div>
        </div>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="2">
        FROM
      </ion-col>
      <ion-col size="10">
        <div *ngFor="let source of fromSpec.pullSources" class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <ion-button [color]="source.scrapeResponse?.failed ? 'error': 'light'"
                          (click)="openScrapeSourceModal(source)">
                {{ getScrapeUrl(source) }}
                <ion-note class="ion-margin-start">{{getNotes(source)}}</ion-note>
              </ion-button>
              <p class="block-error"
                 *ngIf="source.scrapeResponse?.failed">
                {{source.scrapeResponse.errorMessage}}
              </p>
            </div>

            <ng-container *ngIf="needsResourceMapper(source)">
              <div>
                <ion-button color="primary" fill="clear">AS</ion-button>
              </div>
              <div >
                <ion-button color="light"
                            *ngIf="hasProperResourceMapper(source)"
                            (click)="openResourceMapperModal(source)">
                  {{ getLabelForResourceMapper(source) }}
                </ion-button>
                <ion-button color="light"
                            *ngIf="!hasProperResourceMapper(source)"
                            class="error"
                            (click)="openResourceMapperModal(source)">
                  Mapper...
                </ion-button>
              </div>
            </ng-container>
          </div>
          <div class="builder-group--delete">
            <ion-button color="danger" fill="clear" class="ion-float-end" (click)="deleteFromSpec(source)">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <div *ngIf="fromSpec.pushTarget" class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <ion-button color="light"
                          (click)="fromSpec.pushTarget = false">
                Webhook (Push)
                <!--                <ion-note class="ion-margin-start">{{getNotes(source)}}</ion-note>-->
              </ion-button>
            </div>
          </div>
        </div>

        <div>
          <app-menu (valueChanged)="handleSourceType($event.key)"
                    [labelFn]="'label'"
                    [options]="sourceTypes">
            <ion-icon name="add-outline"></ion-icon>
          </app-menu>
        </div>
      </ion-col>
    </ion-row>
    <ion-row *ngIf="needsAgents()">
      <ion-col size="2">
      </ion-col>
      <ion-col size="10">
        <div class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <ion-button color="primary" fill="clear">USING</ion-button>
            </div>
            <div >
              <!--              <ion-button color="light"-->
              <!--                          *ngIf="fromSpecs.transform"-->
              <!--                          (click)="openWebsiteToFeedModal(fromSpec)">-->
              <!--                {{ getLabelForTransformation(fromSpec) }}-->
              <!--              </ion-button>-->
              <!--              <ion-button color="light"-->
              <!--                          class="error">-->
              <!--                Agent...-->
              <!--              </ion-button>-->
              <app-select placeholder="Agent..."
                          [required]="true"
                          [labelFn]="getAgentLabelProvider"
                          (valueChanged)="fromSpec.agent = $event"
                          [options]="getAgents()"></app-select>
            </div>

          </div>
        </div>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="2">
        WHERE
      </ion-col>
      <ion-col size="10">
        <div *ngFor="let whereSpec of whereSpecs" class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <app-select [value]="whereSpec.type"
                          (valueChanged)="whereSpec.type = $event"
                          [options]="['include', 'exclude']"></app-select>

            </div>
            <div >
              <ion-button color="primary" fill="clear">IF</ion-button>
            </div>
            <div >
              <app-select [value]="whereSpec.field"
                          (valueChanged)="whereSpec.field = $event"
                          [options]="['title', 'description', 'link']"></app-select>

            </div>
            <div >
              <app-select [value]="whereSpec.negate"
                          (valueChanged)="whereSpec.negate = $event"
                          [options]="['-', 'not']"></app-select>
            </div>
            <div >
              <app-select [value]="whereSpec.operator"
                          (valueChanged)="whereSpec.operator = $event"
                          [options]="['contains', 'endsWith', 'startsWith']"></app-select>
            </div>
            <div >
              <ion-input aria-label="text"
                         fill="outline"
                         [required]="true"
                         minlength="3"
                         [(ngModel)]="whereSpec.value"
                         placeholder="type here"></ion-input>
            </div>
          </div>
          <div class="builder-group--right">
            <ion-button color="danger" fill="clear" class="ion-float-end" (click)="deleteWhereSpec(whereSpec)">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <div>
          <ion-button color="light" (click)="addWhereSpec()">
            ...
          </ion-button>
        </div>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="2">
        FETCH
      </ion-col>
      <ion-col size="10">
        <div class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <app-select [value]="frequencyOptions[0]"
                          [labelFn]="'label'"
                          (valueChanged)="fetchSpec.frequencyMin = $event.key"
                          [options]="frequencyOptions"></app-select>
            </div>
            <div >
              <ion-button color="primary" fill="clear">WITH</ion-button>
            </div>
            <div >
              <ion-button color="light">
                Fulltext
              </ion-button>
            </div>
            <div >
              <ion-button color="light">
                Privacy
              </ion-button>
            </div>
            <div >
              <app-menu [options]="['Fulltext', 'Item Approval', 'Inline Images', 'Item Refinement']">
                <ion-icon name="add-outline"></ion-icon>
              </app-menu>
            </div>
          </div>
        </div>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="2">
        SINK
      </ion-col>
      <ion-col size="10">
        <div *ngFor="let sinkSpec of sinkSpecs" class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <app-select (valueChanged)="sinkSpec.scope = $event.key"
                          [options]="throttleOptions"></app-select>
            </div>
            <div >
              <ion-button color="primary" fill="clear">INTO</ion-button>
            </div>
            <div  *ngFor="let target of sinkSpec.targets">
              <ion-button color="light">
                {{target.name()}}
                <!--                <ion-note class="ion-margin-start">public, max 50</ion-note>-->
                <ion-note class="ion-margin-start">{{target.description()}}</ion-note>
              </ion-button>
            </div>
          </div>
        </div>
        <div>
          <app-menu [options]="['Email', 'Webhook', 'Archive', 'Feed']">
            <ion-icon name="add-outline"></ion-icon>
          </app-menu>
        </div>
      </ion-col>
    </ion-row>

    <!--    <ion-card-->
    <!--      color="danger"-->
    <!--      *ngIf="-->
    <!--        handler.getDiscovery() &&-->
    <!--        !handler.getDiscovery().failed &&-->
    <!--        !isSourceSupported()-->
    <!--      "-->
    <!--    >-->
    <!--      <ion-card-header>-->
    <!--        <ion-card-title>Source is not supported</ion-card-title>-->
    <!--      </ion-card-header>-->
    <!--      <ion-card-content>-->
    <!--        The URL returns a mimetype {{ mimetype() }} that is not supported.-->
    <!--      </ion-card-content>-->
    <!--    </ion-card>-->
  </div>
</ion-content>

<ion-modal #scrapeSourceModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="scrapeSourceModal.dismiss()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Source</ion-title>
        <ion-button slot="end" color="primary" (click)="dismissScrapeSourceModal()">
          Save
        </ion-button>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-scrape-source [scrapeRequest]="scrapeSourceModalContext.request"
                         [scrapeResponse]="scrapeSourceModalContext.response"
                         (requestChanged)="scrapeSourceModalContext.request = $event"
                         (responseChanged)="scrapeSourceModalContext.response = $event"></app-scrape-source>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal #websiteToFeedModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="websiteToFeedModal.dismiss()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Feed</ion-title>
        <ion-button slot="end" color="primary" (click)="dismissWebsiteToFeedModal()">
          Save
        </ion-button>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-transform-website-to-feed [scrapeRequest]="websiteToFeedModalContext.request"
                                     (feedChanged)="websiteToFeedModalContext.feed = $event"
                                     [feed]="websiteToFeedModalContext.feed"
                                     [scrapeResponse]="websiteToFeedModalContext.response"
      ></app-transform-website-to-feed>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal #feedModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="feedModal.dismiss()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Feed</ion-title>
        <ion-button slot="end" color="success" (click)="dismissFeedModal()">
          Save
        </ion-button>
      </ion-toolbar>
    </ion-header>
    <ion-content>

    </ion-content>
  </ng-template>
</ion-modal>
