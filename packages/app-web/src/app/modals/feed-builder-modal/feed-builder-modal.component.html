<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="closeModal()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Builder</ion-title>
    <ion-button slot="end" color="primary" (click)="save()">
      Save
    </ion-button>
  </ion-toolbar>
</ion-header>
<ion-content>
  <p-splitter layout="vertical">
    <ng-template pTemplate style="position: relative; overflow-y: auto;">
      <div class="flex" style="flex-direction: column;">
        <ion-row>
          <ion-col size="2" class="builder-label">
            FROM
          </ion-col>
          <ion-col size="10">
            <div *ngFor="let source of builder.sources.sources; let i = index"
                 class="flex">
              <div class="flex">
                <ion-button color="light"
                            [ngClass]="{error: hasError(source)}"
                            (click)="openScrapeSourceModal(source)">
                  {{ getRequestLabel(source) }}
                  <ion-note *ngIf="!source.pending" class="ion-margin-start">{{getResponseLabel(source)}}</ion-note>
                  <ion-spinner *ngIf="source.pending" name="dots" class="ion-margin-start"></ion-spinner>
                </ion-button>

                <div *ngIf="!source.pending && !source.error && (i === 0 || builder.sources.needsResourceMapper(source))" style="display: flex;">
                  <ion-button color="primary" fill="clear">AS</ion-button>

                  <app-menu [options]="builder.sources.getMapperOptions()"
                            [labelFn]="'label'"
                            *ngIf="!source.hasResourceMapper()"
                            [error]="builder.sources.needsResourceMapper(source) && !source.isResponseMapperValid()"
                            (valueChanged)="openResourceMapperModal(source, $event.key)">
                    {{getLabelForSource(source)}}
                  </app-menu>

                  <ng-container *ngIf="source.hasResourceMapper()">
                    <ion-button color="light"
                                [ngClass]="{error: !source.isResponseMapperValid()}"
                                (click)="openResourceMapperModal(source)">
                      {{getLabelForSource(source)}}
                    </ion-button>
                    <ion-button color="danger" fill="clear" (click)="source.deleteResourceMapper()">
                      <ion-icon name="close-outline"></ion-icon>
                    </ion-button>
                  </ng-container>
                </div>
              </div>
              <div class="builder-group--right">
                <ion-button color="danger"
                            fill="clear"
                            class="ion-float-end"
                            (click)="builder.sources.deleteSource(source)">
                  <ion-icon name="close-outline"></ion-icon>
                </ion-button>
              </div>
            </div>

            <ion-button color="light"
                        (click)="addSource()"
                        *ngIf="builder.sources.canAddSource()">
              <ion-icon name="add-outline"></ion-icon>
            </ion-button>

            <div class="flex" *ngIf="builder.sources.sources.length > 0">
              <ion-button color="primary" fill="clear">FETCH</ion-button>
              <app-select [labelFn]="'label'"
                          (valueChanged)="builder.fetch.every.minutes = $event.key"
                          [options]="fetchFrequencyOptions"></app-select>

              <ion-button color="primary" fill="clear">WITH</ion-button>

              <app-menu [options]="['Fulltext', 'Item Approval', 'Inline Images', 'Item Refinement']">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Plugins
              </app-menu>

            </div>

            <div class="flex" *ngIf="builder.isProvidesFields()">
              <ion-button color="primary" fill="clear">RETENTION</ion-button>
              <ion-button color="light">Auto</ion-button>
            </div>

<!--            <div class="builder-group&#45;&#45;blocks" *ngIf="builder.sources.needsGroupBy()">-->
<!--              <div>-->
<!--                <ion-button color="primary" fill="clear">GROUP BY</ion-button>-->
<!--              </div>-->
<!--              <div>-->
<!--                <app-select [labelFn]="'name'"-->
<!--                            placeholder="Auto"-->
<!--                            [options]="fields()"></app-select>-->
<!--              </div>-->
<!--            </div>-->
            <div class="flex" *ngIf="builder.isProvidesFields()">
              <div>
                <ion-button color="primary" fill="clear">REFINE</ion-button>
              </div>
              <div>
                <div style="display: flex; flex-direction: row; flex-wrap: wrap;">
                  <ng-container *ngFor="let refine of builder.refines">
                    <app-feed-builder-card title="Modify Field"
                                           *ngIf="refine.update"
                                           (dismiss)="builder.deleteRefine(refine)">
                      <ion-list>
                        <ion-item>
                          <app-select [required]="true"
                                      placeholder="Pick a field"
                                      [labelFn]="'name'"
                                      [options]="fields"></app-select>
                        </ion-item>
                        <ion-item>
                          <input type="text"
                                 placeholder="Search RegEx"
                                 required
                                 pInputText />
                        </ion-item>
                        <ion-item>
                          <input type="text"
                                 placeholder="Replacement"
                                 required
                                 pInputText />
                        </ion-item>
                      </ion-list>
                    </app-feed-builder-card>

                    <app-feed-builder-card title="Create Field"
                                           *ngIf="refine.create"
                                           (dismiss)="builder.deleteRefine(refine)">
                      <ion-list>
                        <ion-item>
                          <app-select [required]="true"
                                      placeholder="Pick a field"
                                      [options]="['title','description','link']"></app-select>
                        </ion-item>
                        <ion-item>
                          <input type="text"
                                 required
                                 placeholder="Extract RegEx"
                                 pInputText />
                        </ion-item>
                        <ion-item>
                          <input type="text"
                                 required
                                 placeholder="Alias As"
                                 pInputText />
                        </ion-item>
                      </ion-list>
                    </app-feed-builder-card>
                  </ng-container>
                </div>

                <div class="flex" *ngIf="builder.canAddRefine()">
                  <app-menu (valueChanged)="addFieldRefinement($event)"
                            [labelFn]="'label'"
                            [options]="fieldRefineOptions">
                    <ion-icon name="add-outline" slot="start"></ion-icon>
                    Field
                  </app-menu>
                </div>
              </div>
            </div>
          </ion-col>
        </ion-row>
        <ion-row *ngIf="builder.needsAgent()">
          <ion-col push="2" size="10">
            <ion-button color="primary" fill="clear">WITH AGENT</ion-button>
            <ion-button color="light"
                        (click)="openAgentModal()"
                        *ngIf="!builder.hasAgent() && agents.length === 0"
                        class="error">
              Agent...
            </ion-button>
            <app-select [labelFn]="labelAgent"
                        [required]="true"
                        placeholder="Agent..."
                        *ngIf="agents.length > 0"
                        (valueChanged)="builder.setAgent($event)"
                        [options]="agents">
            </app-select>
          </ion-col>
        </ion-row>

        <ion-row *ngIf="builder.sources.isFeed()">
          <ion-col size="2" class="builder-label">
            WHERE
          </ion-col>
          <ion-col size="10">
            <div *ngFor="let filter of builder.filters" class="flex">
              <div class="flex">
                <app-select [value]="filter.type"
                            [disabled]="hasFields"
                            (valueChanged)="filter.type = $event"
                            [options]="['include', 'exclude']"></app-select>

                <ion-button color="primary" fill="clear">IF</ion-button>

                <app-select [value]="filter.field"
                            (valueChanged)="filter.field = $event"
                            [options]="['title', 'description', 'link']"></app-select>

                <app-select [value]="filter.negate"
                            (valueChanged)="filter.negate = $event"
                            [options]="['-', 'not']"></app-select>

                <app-select [value]="filter.operator"
                            (valueChanged)="filter.operator = $event"
                            [options]="['contains', 'endsWith', 'startsWith']"></app-select>

                <ion-input aria-label="text"
                           fill="outline"
                           [required]="true"
                           minlength="3"
                           [(ngModel)]="filter.value"
                           placeholder="type here"></ion-input>
              </div>

              <!-- DELETE FILTER ------------------------------------------- -->

              <div class="builder-group--right">
                <ion-button color="danger"
                            fill="clear"
                            class="ion-float-end"
                            (click)="builder.deleteFilter(filter)">
                  <ion-icon name="close-outline"></ion-icon>
                </ion-button>
              </div>
            </div>

            <ion-button color="light"
                        *ngIf="builder.canAddFilter()"
                        (click)="builder.addFilter()">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Filter
            </ion-button>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="2" class="builder-label">
            PERSIST
          </ion-col>
          <ion-col size="10">
            <div class="flex">

              <!-- SCOPING ------------------------------------------------- -->

              <app-select [labelFn]="'label'"
                          (valueChanged)="handleSinkScopeChange($event.key, builder.sink)"
                          *ngIf="!isDefined(builder.sink.segmented)"
                          [disabled]="hasFields"
                          [options]="sinkScopeOptions"></app-select>

              <ion-button color="light"
                          [ngClass]="{error: builder.hasSegmentedSink() && !builder.isSegmentedSinkValid()}"
                          *ngIf="isDefined(builder.sink.segmented)"
                          (click)="openSegmentedDeliveryModal()">
                Scoped
              </ion-button>

              <div>
                <ion-button color="primary" fill="clear">INTO</ion-button>
              </div>


              <!-- TARGETS ------------------------------------------------- -->

              <div  *ngFor="let target of builder.sink.targets">
                <ng-container *ngIf="isDefined(target.feed)">
                  <app-select placeholder="Feed..."
                              *ngIf="!isDefined(target.feed.create) && !isDefined(target.feed.existing)"
                              [required]="true"
                              [labelFn]="'label'"
                              [hideFilter]="true"
                              (valueChanged)="handleFeedType($event.key, target)"
                              [options]="feedTypeOptions"></app-select>

                  <!-- NEW FEED -------------------------------------------- -->

                  <app-feed-builder-card title="New Feed"
                                         (dismiss)="builder.removeTargetInSink(target, builder.sink)"
                                         *ngIf="isDefined(target.feed.create)">
                    <ion-list>
                      <ion-item>
                        <input type="text"
                               placeholder="Title"
                               required
                               pInputText />
                      </ion-item>
                      <ion-item>
                        <input type="text"
                               placeholder="Description"
                               required
                               pInputText />
                      </ion-item>
                      <ion-item>
                        <p-chips placeholder="Enter tags"></p-chips>
                      </ion-item>
                      <ion-item>
                        <input type="url"
                               placeholder="Website"
                               pInputText />
                      </ion-item>
                      <!--                        <ion-item>-->
                      <!--                          <input type="text"-->
                      <!--                                 placeholder="Url"-->
                      <!--                                 required-->
                      <!--                                 pInputText />-->
                      <!--                        </ion-item>-->
                    </ion-list>
                  </app-feed-builder-card>


                  <!-- EXISTING FEED ---------------------------------------- -->

                  <app-feed-builder-card title="Existing Feed"
                                         (dismiss)="builder.removeTargetInSink(target, builder.sink)"
                                         *ngIf="isDefined(target.feed.existing)">
                    <ion-list>
                      <ion-list-header>
                        <ion-searchbar></ion-searchbar>
                      </ion-list-header>
                      <ion-item>
                        <ion-label>Bucket 1</ion-label>
                      </ion-item>
                    </ion-list>

                  </app-feed-builder-card>
                </ng-container>


                <!-- EMAIL ------------------------------------------------- -->

                <app-feed-builder-card title="Email"
                                       (dismiss)="builder.removeTargetInSink(target, builder.sink)"
                                       *ngIf="isDefined(target.email)">
                  <ion-list>
                    <ion-item>
                      <input type="email"
                             placeholder="Type Email"
                             required
                             pInputText />
                    </ion-item>
                  </ion-list>
                </app-feed-builder-card>


                <!-- WEBHOOK ----------------------------------------------- -->

                <app-feed-builder-card title="Webhook"
                                       (dismiss)="builder.removeTargetInSink(target, builder.sink)"
                                       *ngIf="isDefined(target.webhook)">
                  <ion-list>
                    <ion-item>
                      <input type="url"
                             placeholder="Type Url"
                             required
                             pInputText />
                    </ion-item>
                  </ion-list>
                </app-feed-builder-card>

              </div>
              <app-menu [options]="sinkTargetOptions"
                        [labelFn]="'label'"
                        [error]="builder.sink.targets?.length === 0"
                        (valueChanged)="addTargetToSink($event.key, builder.sink)">
                <ion-icon name="add-outline"></ion-icon>
              </app-menu>
            </div>
          </ion-col>
        </ion-row>
      </div>
    </ng-template>
    <ng-template pTemplate>
      <div style="flex: 1; display: flex; flex-direction: column; margin-top: 20px;">
        <div style="align-self: center;">
          <ion-segment #preview value="preview" mode="ios" style="max-width: 300px">
            <ion-segment-button value="preview">
              <ion-label>Preview</ion-label>
            </ion-segment-button>
            <ion-segment-button value="request">
              <ion-label>Request</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <div style="flex: 1; justify-content: center; align-items: center; position: relative; overflow-y: auto">
          <div *ngIf="preview.value === 'preview'">

          </div>
          <div *ngIf="preview.value === 'request'" style="position: absolute">
            <pre>{{ builder.build() | json }}</pre>
          </div>
        </div>
      </div>
    </ng-template>
  </p-splitter>

</ion-content>


<!-- SCRAPE MODAL ---------------------------------------------------------- -->

<ion-modal #scrapeSourceModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="dismissScrapeSourceModal()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Source</ion-title>
        <ion-buttons slot="end">
          <ion-button color="success" (click)="applyChangesFromScrapeSourceModal()">
            Apply
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-scrape-source [scrapeRequest]="scrapeSourceModalContext.request"
                         [scrapeResponse]="scrapeSourceModalContext.response"
                         [pickFragment]="scrapeSourceModalContext.pickFragment"
                         (requestChanged)="scrapeSourceModalContext.request = $event"
                         (responseChanged)="scrapeSourceModalContext.response = $event"></app-scrape-source>
    </ion-content>
  </ng-template>
</ion-modal>


<!-- WEBSITE TO FEED MODAL ------------------------------------------------- -->

<ion-modal #websiteToFeedModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)=dismissWebsiteToFeedModal()>
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Website to Feed</ion-title>
        <ion-buttons slot="end">
          <ion-button color="primary"
                      (click)="applyChangesFromebsiteToFeedModal()">
            Apply
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-transform-website-to-feed [scrapeRequest]="websiteToFeedModalContext.sourceBuilder.request"
                                     [scrapeResponse]="websiteToFeedModalContext.sourceBuilder.response"
                                     [feed]="websiteToFeedModalContext.feed"
                                     (feedChanged)="websiteToFeedModalContext.feed = $event"
      ></app-transform-website-to-feed>
    </ion-content>
  </ng-template>
</ion-modal>


<!-- AGENT MODAL ----------------------------------------------------------- -->

<ion-modal #agentModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="dismissAgentModal()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Agents</ion-title>
        <ion-buttons slot="end">
          <ion-button color="primary"
                      (click)="applyChangesFromAgentModal()">
            Apply
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-agents></app-agents>
    </ion-content>
  </ng-template>
</ion-modal>


<!-- SEGMENTED DELIVERY MODAL ---------------------------------------------- -->

<ion-modal #segmentedDeliveryModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="dismissSegmentedDeliveryModal()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Scoped Output</ion-title>
        <ion-buttons slot="end">
          <ion-button color="primary"
                      (click)="applyChangesFromSegmentedDeliveryModal()">
            Apply
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-segmented-output [fields]="fields"
                            (segmentedChanged)="segmentedDeliveryModalContext.segmented = $event"
                            [segmented]="segmentedDeliveryModalContext.segmented"></app-segmented-output>
    </ion-content>
  </ng-template>
</ion-modal>
