<ion-header>
  <ion-toolbar>
    <ion-title>Builder</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="closeModal()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content>
  <div class="flex__column">
    <ion-row>
      <ion-col size="2">
        SELECT
      </ion-col>
      <ion-col size="10">
        <app-select value="feed"
                    [hideFilter]="true"
                    (valueChanged)="selectSpec = $event"
                    [selectOptions]="getOptionsForSelect()"></app-select>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="2">
        FROM
      </ion-col>
      <ion-col size="10">
        <div *ngFor="let fromSpec of fromSpecs" class="builder-group">
          <div class="builder-group--blocks">
            <div class="builder-group--block">
              <ion-button [color]="fromSpec.scrapeResponse?.failed ? 'error': 'light'"
                          (click)="openScrapeSourceModal(fromSpec)">
                {{ getScrapeUrl(fromSpec) }} <ion-note class="ion-margin-start">{{getNotes(fromSpec)}}</ion-note>
              </ion-button>
              <p class="block-error"
                 *ngIf="fromSpec.scrapeResponse?.failed">
                {{fromSpec.scrapeResponse.errorMessage}}
              </p>
            </div>

            <ng-container *ngIf="needsTransform(fromSpec)">
              <div class="builder-group--block">
                <ion-button color="primary" fill="clear">AS</ion-button>
              </div>
              <div class="builder-group--block">
                <ion-button color="light" *ngIf="fromSpec.transform" (click)="openWebsiteToFeedModal(fromSpec)">
                  {{ getLabelForTransformation(fromSpec) }}
                </ion-button>
                <ng-container *ngIf="!fromSpec.transform">
                  <ion-button color="light" (click)="openWebsiteToFeedModal(fromSpec)">
                    ...
                  </ion-button>
                  <p class="block-error">
                    Transformer needed
                  </p>
                </ng-container>
              </div>
            </ng-container>
          </div>
          <div class="builder-group--delete">
            <ion-button color="danger" fill="clear" class="ion-float-end" (click)="deleteFromSpec(fromSpec)">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <div>
          <ion-button color="light" (click)="openScrapeSourceModal()">
            <ion-icon name="add-outline"></ion-icon>
          </ion-button>
        </div>

      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="2">
        WHERE
      </ion-col>
      <ion-col size="10">
        <div *ngFor="let whereSpec of whereSpecs" class="builder-group">
          <div class="builder-group--blocks">
            <div class="builder-group--block">
              <app-select label="Field"
                          [value]="whereSpec.field"
                          (valueChanged)="whereSpec.field = $event"
                          [selectOptions]="['title', 'description', 'link']"></app-select>

            </div>
            <div class="builder-group--block">
              <app-select label="Negation"
                          [value]="whereSpec.negate"
                          (valueChanged)="whereSpec.negate = $event"
                          [selectOptions]="['-', 'not']"></app-select>
            </div>
            <div class="builder-group--block">
              <app-select label="Operator"
                          [value]="whereSpec.operator"
                          (valueChanged)="whereSpec.operator = $event"
                          [selectOptions]="['contains', 'endsWith', 'startsWith']"></app-select>
            </div>
            <div class="builder-group--block">
              <ion-input aria-label="text"
                         [(ngModel)]="whereSpec.value"
                         placeholder="type here"></ion-input>
            </div>
          </div>
        </div>

        <div>
          <ion-button color="light" (click)="addWhereSpec()">
            <ion-icon name="add-outline"></ion-icon>
          </ion-button>
        </div>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="2">
        FETCH
      </ion-col>
      <ion-col size="10">
        <app-select value="240"
                    [selectOptions]="getFetchFrequencyOptions()"></app-select>
<!--        <app-select [selectOptions]="['Fulltext', 'Review Items']">-->
<!--          <ion-icon name="add-outline"></ion-icon>-->
<!--        </app-select>-->
        <ion-button color="light">
          Fulltext
        </ion-button>

      <app-menu [selectOptions]="['Fulltext', 'Review Items']">
        <ion-icon name="add-outline"></ion-icon>
      </app-menu>

      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="2">
        INTO
      </ion-col>
      <ion-col size="10">
        <ion-button color="light">
          Feed <ion-note class="ion-margin-start">public, Retention 50</ion-note>
        </ion-button>

        <app-menu [selectOptions]="['Email', 'Webhook']">
          <ion-icon name="add-outline"></ion-icon>
        </app-menu>
      </ion-col>
    </ion-row>

<!--    <ion-card-->
<!--      color="danger"-->
<!--      *ngIf="-->
<!--        handler.getDiscovery() &&-->
<!--        !handler.getDiscovery().failed &&-->
<!--        !isSourceSupported()-->
<!--      "-->
<!--    >-->
<!--      <ion-card-header>-->
<!--        <ion-card-title>Source is not supported</ion-card-title>-->
<!--      </ion-card-header>-->
<!--      <ion-card-content>-->
<!--        The URL returns a mimetype {{ mimetype() }} that is not supported.-->
<!--      </ion-card-content>-->
<!--    </ion-card>-->
  </div>
</ion-content>

<ion-modal #scrapeSourceModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="scrapeSourceModal.dismiss()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Source</ion-title>
        <ion-button slot="end" color="success" (click)="dismissScrapeSourceModal()">
          Save
        </ion-button>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-scrape-source [scrapeRequest]="scrapeSourceModalContext.request"
                         [scrapeResponse]="scrapeSourceModalContext.response"
                         (requestChanged)="scrapeSourceModalContext.request = $event"
                         (responseChanged)="scrapeSourceModalContext.response = $event"></app-scrape-source>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal #websiteToFeedModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="websiteToFeedModal.dismiss()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Feed</ion-title>
        <ion-button slot="end" color="success" (click)="dismissWebsiteToFeedModal()">
          Save
        </ion-button>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-transform-website-to-feed [scrapeRequest]="websiteToFeedModalContext.request"
                                     (feedChanged)="websiteToFeedModalContext.feed = $event"
                                     [feed]="websiteToFeedModalContext.feed"
                                     [scrapeResponse]="websiteToFeedModalContext.response"
      ></app-transform-website-to-feed>
    </ion-content>
  </ng-template>
</ion-modal>
