<ion-header>
  <ion-toolbar>
<!--    <ion-buttons slot="start">-->
<!--      <ion-button (click)="closeModal()">-->
<!--        <ion-icon name="close-outline"></ion-icon>-->
<!--      </ion-button>-->
<!--    </ion-buttons>-->
    <ion-title>Builder</ion-title>
<!--    <ion-button slot="end" color="primary" (click)="build()">-->
<!--      Save-->
<!--    </ion-button>-->
  </ion-toolbar>
</ion-header>
<ion-content>
  <div style="flex: 2">
    <ion-row>
      <ion-col size="2">
        FROM
      </ion-col>
      <ion-col size="10">
        <div *ngFor="let source of builder.sources.sources" class="builder-group">
          <div class="builder-group--blocks">
            <div>
              <ion-button [color]="source.errors ? 'error': 'light'"
                          (click)="openScrapeSourceModal(source)">
                {{ getRequestLabel(source) }}
                <ion-note class="ion-margin-start">{{getResponseLabel(source)}}</ion-note>
              </ion-button>
              <ul class="block-error" *ngFor="let error of source.errors">
                <li>{{ error }}</li>
              </ul>
            </div>
            <div *ngIf="source.mapper.needsMapper()" style="display: flex;">
              <div>
                <ion-button color="primary" fill="clear">AS</ion-button>
              </div>
              <div>
                <app-menu [options]="source.mapper.options"
                          [labelFn]="'label'"
                          (valueChanged)="setMapper(source, $event.key)">
                  {{getLabelForSource(source)}}
                </app-menu>
              </div>
            </div>
          </div>
        </div>

        <div>
          <ion-button color="light"
                      (click)="addSource()"
                      *ngIf="builder.sources.canAddSource()">
            <ion-icon name="add-outline"></ion-icon>
          </ion-button>
        </div>
      </ion-col>
    </ion-row>
    <ion-row *ngIf="builder.sources.needsAgent()">
      <ion-col push="2" size="10">
        <div class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <ion-button color="primary" fill="clear">WITH AGENT</ion-button>
            </div>
            <div>
              <ion-button color="light"
                          (click)="createAgent()"
                          *ngIf="!builder.sources.hasAgent() && agents.length === 0"
                          class="error">
                Agent...
              </ion-button>
              <app-select [labelFn]="labelAgent"
                          [required]="true"
                          placeholder="Agent..."
                          *ngIf="agents.length > 0"
                          (valueChanged)="builder.sources.agent = $event"
                          [options]="agents">
              </app-select>
            </div>

          </div>
        </div>
      </ion-col>
    </ion-row>
<!--    <ion-row *ngIf="builder.sources.needsDeduplication()">-->
<!--      <ion-col push="2" size="10">-->
<!--        <div class="builder-group">-->
<!--          <div class="builder-group&#45;&#45;blocks">-->
<!--            <div >-->
<!--              <ion-button color="primary" fill="clear">DEDUPLICATE BY</ion-button>-->
<!--            </div>-->
<!--            <div>-->
<!--              <ion-button color="light"-->
<!--                          (click)="createAgent()"-->
<!--                          *ngIf="!builder.sources.hasAgent() && agents.length === 0"-->
<!--                          class="error">-->
<!--                Agent...-->
<!--              </ion-button>-->
<!--              <app-select [labelFn]="labelAgent"-->
<!--                          [required]="true"-->
<!--                          placeholder="Agent..."-->
<!--                          *ngIf="agents.length > 0"-->
<!--                          (valueChanged)="builder.sources.agent = $event"-->
<!--                          [options]="agents">-->
<!--              </app-select>-->
<!--            </div>-->

<!--          </div>-->
<!--        </div>-->
<!--      </ion-col>-->
<!--    </ion-row>-->
    <ion-row *ngIf="builder.isFeed()">
      <ion-col size="2">
        WHERE
      </ion-col>
      <ion-col size="10">
        <div *ngFor="let filter of builder.filters" class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <app-select [value]="filter.type"
                          (valueChanged)="filter.type = $event"
                          [options]="['include', 'exclude']"></app-select>

            </div>
            <div >
              <ion-button color="primary" fill="clear">IF</ion-button>
            </div>
            <div >
              <app-select [value]="filter.field"
                          (valueChanged)="filter.field = $event"
                          [options]="['title', 'description', 'link']"></app-select>

            </div>
            <div >
              <app-select [value]="filter.negate"
                          (valueChanged)="filter.negate = $event"
                          [options]="['-', 'not']"></app-select>
            </div>
            <div >
              <app-select [value]="filter.operator"
                          (valueChanged)="filter.operator = $event"
                          [options]="['contains', 'endsWith', 'startsWith']"></app-select>
            </div>
            <div >
              <ion-input aria-label="text"
                         fill="outline"
                         [required]="true"
                         minlength="3"
                         [(ngModel)]="filter.value"
                         placeholder="type here"></ion-input>
            </div>
          </div>
          <div class="builder-group--right">
            <ion-button color="danger" fill="clear" class="ion-float-end" (click)="builder.deleteFilter(filter)">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <div>
          <ion-button color="light"
                      *ngIf="builder.canAddFilter()"
                      (click)="builder.addFilter()">
            <ion-icon name="add-outline"></ion-icon>
          </ion-button>
        </div>
      </ion-col>
    </ion-row>

    <ion-row *ngIf="builder.isFeed()">
      <ion-col size="2">
        REFINE
      </ion-col>
      <ion-col size="10">
        <div class="builder-group">
<!--          <div style="display: flex" *ngFor="let field of fields()">-->
<!--            <div style="border: 1px solid white;">-->
<!--              <ion-input [readonly]="true" [value]="field.name"></ion-input>-->
<!--              <app-select [options]="['Replace']"></app-select>-->
<!--            </div>-->
<!--          </div>-->
          <div class="builder-group--blocks">
            <div>
              <app-menu [options]="['Add Field', 'Modify Field']">
                <ion-icon name="add-outline"></ion-icon>
              </app-menu>
            </div>
          </div>
        </div>
      </ion-col>
    </ion-row>

<!--    <ion-row *ngIf="builder.isFeed()">-->
<!--      <ion-col size="2">-->
<!--        FETCH-->
<!--      </ion-col>-->
<!--      <ion-col size="10">-->
<!--        <div class="builder-group">-->
<!--          <div class="builder-group&#45;&#45;blocks">-->
<!--            <div>-->
<!--              <app-select [value]="frequencyOptions[0]"-->
<!--                          [labelFn]="'label'"-->
<!--                          (valueChanged)="fetchSpec.frequencyMin = $event.key"-->
<!--                          [options]="frequencyOptions"></app-select>-->
<!--            </div>-->
<!--            <div>-->
<!--              <ion-button color="primary" fill="clear">WITH</ion-button>-->
<!--            </div>-->
<!--            <div>-->
<!--              <ion-button color="light">-->
<!--                Fulltext-->
<!--              </ion-button>-->
<!--            </div>-->
<!--            <div >-->
<!--              <app-menu [options]="['Fulltext', 'Item Approval', 'Inline Images', 'Item Refinement']">-->
<!--                <ion-icon name="add-outline"></ion-icon>-->
<!--              </app-menu>-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->
<!--      </ion-col>-->
<!--    </ion-row>-->
    <ion-row>
      <ion-col size="2">
        DELIVER
      </ion-col>
      <ion-col size="10">
        <div *ngFor="let sink of builder.sinks" class="builder-group">
          <div class="builder-group--blocks">
            <div >
              <app-select (valueChanged)="sink.scope = $event.key"
                          [options]="throttleOptions"></app-select>
            </div>
            <div >
              <ion-button color="primary" fill="clear">INTO</ion-button>
            </div>
            <div  *ngFor="let target of sink.targets">
              <ion-button color="light">
                {{target.name()}}
                <!--                <ion-note class="ion-margin-start">public, max 50</ion-note>-->
                <ion-note class="ion-margin-start">{{target.description()}}</ion-note>
              </ion-button>
            </div>
          </div>
        </div>
        <div>
          <app-menu [options]="['Email', 'Webhook', 'Archive', 'Feed']">
            <ion-icon name="add-outline"></ion-icon>
          </app-menu>
        </div>
      </ion-col>
    </ion-row>


  </div>
  <div style="flex: 1; display: flex; border-top: 1px solid #2b2a2a;">
    <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
      <div>Preview</div>
      <ion-button (click)="print()">print</ion-button>
    </div>
  </div>

</ion-content>

<ion-modal #scrapeSourceModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="scrapeSourceModal.dismiss()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Source</ion-title>
        <ion-button slot="end" color="primary" (click)="dismissScrapeSourceModal()">
          Save
        </ion-button>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-scrape-source [scrapeRequest]="scrapeSourceModalContext.sourceBuilder.request"
                         [scrapeResponse]="scrapeSourceModalContext.sourceBuilder.response"
                         [pickFragment]="scrapeSourceModalContext.pickFragment"
                         (requestChanged)="scrapeSourceModalContext.sourceBuilder.request = $event"
                         (responseChanged)="scrapeSourceModalContext.sourceBuilder.response = $event"></app-scrape-source>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal #websiteToFeedModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="websiteToFeedModal.dismiss()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Feed</ion-title>
        <ion-button slot="end" color="primary" (click)="dismissWebsiteToFeedModal()">
          Save
        </ion-button>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-transform-website-to-feed [scrapeRequest]="websiteToFeedModalContext.sourceBuilder.request"
                                     (feedChanged)="websiteToFeedModalContext.feed = $event"
                                     [feed]="websiteToFeedModalContext.feed"
                                     [scrapeResponse]="websiteToFeedModalContext.sourceBuilder.response"
      ></app-transform-website-to-feed>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal #agentModal>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="agentModal.dismiss()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Agents</ion-title>
<!--        <ion-button slot="end" color="success" (click)="dismissFeedModal()">-->
<!--          Save-->
<!--        </ion-button>-->
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-agents></app-agents>
    </ion-content>
  </ng-template>
</ion-modal>
