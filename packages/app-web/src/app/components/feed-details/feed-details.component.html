<ion-row class="ion-margin-top">
  <h2 class="ion-no-margin" style="display: inline">
    {{ repository.title }}
  </h2>
  <ion-chip
    (click)="editRepository()"
    *ngIf="repository.visibility === GqlVisibility.IsPrivate"
  >Private</ion-chip
  >
</ion-row>
<ion-toolbar class="ion-margin-vertical" style="--background: transparent">
  <ion-buttons slot="start">
    <ion-button>
      <ion-icon
        name="globe-outline"
        color="primary"
        slot="start"
      ></ion-icon>
      Visit website
    </ion-button>
    <ion-button title="Pulls per week">
      <ion-icon
        name="arrow-down-outline"
        color="primary"
        slot="start"
      ></ion-icon>
      Pull 2.3k
    </ion-button>
    <ion-button [href]="feedUrl" color="primary" fill="solid">
      <ion-icon name="logo-rss" slot="start"></ion-icon>
      Feed
    </ion-button>
  </ion-buttons>

  <ion-buttons slot="end">
    <ion-button id="open-sources-modal">
      <ion-icon
        name="git-branch-outline"
        slot="start"
      ></ion-icon>
      <ion-label>
        Sources
        <app-bubble
          *ngIf="hasErrors()"
          color="red"
          slot="end"
        ></app-bubble>
      </ion-label>
      <ion-chip *ngIf="!hasErrors()"
      >{{repository.sources.length}}</ion-chip
      >
    </ion-button>

    <ion-modal trigger="open-sources-modal">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Edit Sources</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="dismissModal()">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <ion-toolbar style="--background: transparent">
            <ion-title>
              {{ repository.sources.length }} Sources
            </ion-title>
            <ion-buttons slot="end">
              <ion-button>
                <ion-icon name="refresh-outline" slot="start"></ion-icon>
                Trigger Refresh
              </ion-button>
              <ion-button
                (click)="editSource()"
              >
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Add Source</ion-button
              >
            </ion-buttons>
          </ion-toolbar>
          <ion-list>
            <ion-item *ngIf="repository.sources.length === 0">
              <ion-label color="danger"
              >No sources defined</ion-label
              >
            </ion-item>
            <ion-item
              *ngFor="let source of repository.sources"
            >
              <app-bubble
                [color]="getHealthColorForSource(source)"
              ></app-bubble>
              <ion-label>
                <h3 class="ion-padding-horizontal">
                  From {{source.page.url}}
                </h3>
                <p class="ion-padding-horizontal">
                  {{getPluginsOfSource(source)}}
                </p>
                <p>
                  <ion-button
                    fill="clear"
                    [color]="source.tags?.length > 0 ? 'medium' : 'primary'"
                    (click)="editTags(source)"
                  >{{ stringifyTags(source) }}</ion-button
                  >
                </p>
                <ion-note
                  color="danger"
                  *ngIf="source.errornous"
                >
                  {{source.lastErrorMessage}}
                </ion-note>
              </ion-label>
              <ion-buttons [collapse]="true">
                <ion-button
                  color="danger"
                  (click)="deleteSource(source)"
                >
                  Delete
                </ion-button>
                <ion-button (click)="editSource(source)">
                  Edit
                </ion-button>
              </ion-buttons>
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-modal>

    <ion-button id="open-settings-modal">
      <ion-icon name="settings-outline"></ion-icon>
    </ion-button>

    <ion-popover
      [showBackdrop]="false"
      trigger="open-settings-modal"
      triggerAction="click"
    >
      <ng-template>
        <ion-content>
          <ion-list>
            <ion-item button="true" (click)="editRepository()">
              <ion-icon
                name="settings-outline"
                slot="start"
              ></ion-icon>
              <ion-label>Edit </ion-label>
            </ion-item>
            <ion-item button="true" (click)="deleteRepository()">
              <ion-icon name="trash-outline" slot="start"></ion-icon>
              <ion-label>Delete </ion-label>
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>
  </ion-buttons>
</ion-toolbar>
<div
  class="description"
  [ngClass]="{'description--flat': !showFullDescription}">
  <ion-row>
    <ion-col>
      <strong>Description</strong>
    </ion-col>
  </ion-row>
  <ion-row>
    <ion-col> {{ repository.description }} </ion-col>
  </ion-row>
  <ion-row>
    <ion-col>
      <dl>
        <dt>Filters</dt>
        <dd>{{getPluginsOfRepository(repository)}}</dd>
        <dt>Created</dt>
        <dd>{{ repository.createdAt | date: dateFormat }}</dd>
        <dt>Last Updated</dt>
        <dd>{{ fromNow(repository.lastUpdatedAt) }} ago</dd>
        <dt>Next Updated</dt>
        <dd>{{ fromNow(repository.nextUpdateAt) }}</dd>
        <dt>Retention Strategy</dt>
        <dd>{{ getRetentionStrategy() }}</dd>
      </dl>
    </ion-col>
  </ion-row>
  <ion-row>
    <ion-button (click)="showFullDescription = !showFullDescription; $event.stopPropagation()" fill="clear" color="dark" style="margin: auto">
      <span *ngIf="showFullDescription">Show less</span>
      <span *ngIf="!showFullDescription">Show more</span>
    </ion-button>
  </ion-row>
</div>
<!--      <div style="position: relative">-->
<!--        <app-histogram [data]="repository.activity"></app-histogram>-->
<!--      </div>-->

<div style="border-radius: 8px">
  <ion-item *ngIf="pages.length === 0 || pages[0].length === 0">
    <ion-label> Feed has no items.</ion-label>
  </ion-item>

  <div style="margin-top: 50px" class="ion-padding">
    <h3>Available articles</h3>
  </div>

  <ion-list style="border-radius: 8px">
    <ng-container *ngFor="let documents of pages">
       <div *ngFor="let document of documents">
        <ion-item lines="full">
          <ion-label>
            <ion-toolbar style="--background: transparent">
              <ion-buttons>
                <ion-note>{{ fromNow(document.publishedAt) }} on {{hostname(document.url)}}</ion-note>
                <ion-note *ngIf="document.tags.length > 0">
                  <em class="ion-padding-start">{{getTags(document)}}</em>
                </ion-note>
              </ion-buttons>
            </ion-toolbar>

            <h2 style="padding-bottom: 5px">
              <a [href]="document.url"
                 target="_blank"
                 referrerpolicy="no-referrer">
                {{ document.contentTitle }}
              </a>
            </h2>

            <p>{{ document.contentText }}</p>
            <div class="ion-margin-top" *ngIf="hasAudioStream(document)">
              <ion-button shape="round"
                          fill="clear"
                          color="dark"
                          *ngIf="playDocument !== document"
                          (click)="playAudio(document)">
                <ion-icon name="play-outline" color="primary" slot="start"></ion-icon>
                Play
              </ion-button>
              <audio controls autoplay style="width: 100%" *ngIf="playDocument === document">
                <source [src]="firstAudioStream(document)">
              </audio>
            </div>
          </ion-label>
         </ion-item>
       </div>
      <ion-item-divider></ion-item-divider>
    </ng-container>
  </ion-list>

  <!--        <div style="text-align: center">-->
  <!--          <ion-button-->
  <!--            color="primary"-->
  <!--            (click)="loadMore()"-->
  <!--            *ngIf="!hasEndReached()"-->
  <!--            >Load older items</ion-button-->
  <!--          >-->
  <!--        </div>-->
  <ion-infinite-scroll
    *ngIf="!hasEndReached()"
    (ionInfinite)="loadMore($event)">
    <ion-infinite-scroll-content></ion-infinite-scroll-content>
  </ion-infinite-scroll>
</div>
