<ion-header>
  <ion-header>
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-button (click)="dismissModal()">
          <ion-icon name="chevron-back-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-title>Source</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="openCodeEditor()"> Code</ion-button>
        <ion-button
          (click)="applyChanges()"
          [disabled]="scrapeRequestFG.invalid || mapperFg.invalid"
          color="success"
          fill="solid"
        >
          Apply
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
</ion-header>
<ion-content>
  <div class="flex flex__column">
    <div>
      <form (ngSubmit)="scrapeUrl()" [formGroup]="scrapeRequestFG">
        <ion-row>
          <ion-col class="builder-label" size="2"> FETCH</ion-col>
          <ion-col class="flex" size="10" style="padding-left: 15px">
            <app-input
              formControlName="url"
              placeholder="https://example.org"
              type="text"
            ></app-input>

            <span class="label">USING</span>
            <app-select
              [formControl]="scrapeRequestFG.controls.renderEngine"
              [items]="renderOptions"
            >
            </app-select>

            <ng-container
              *ngIf="scrapeRequestFG.value.renderEngine === 'chrome'"
            >
              <span class="label">@</span>
              <app-select
                [formControl]="scrapeRequestFG.controls.screenResolution"
                [items]="screenResolutions"
                placeholder="Resolution"
              ></app-select>
            </ng-container>
          </ion-col>
        </ion-row>
        <ion-row *ngIf="scrapeResponse">
          <ion-col
            class="ion-padding-start"
            push="2"
            size="10"
            style="color: gray"
          >
            {{ scrapeResponse.debug.contentType }}
          </ion-col>
        </ion-row>

        <ion-row *ngIf="scrapeRequestFG.controls.actions.enabled">
          <ion-col
            (click)="logFormGroupStatus(scrapeRequestFG.controls.actions)"
            class="builder-label"
            size="2"
          >
            <span
              [ngClass]="{
                error:
                  scrapeRequestFG.controls.actions.invalid &&
                  scrapeRequestFG.controls.actions.enabled
              }"
              >ACTIONS</span
            >
          </ion-col>
          <ion-col size="10">
            <app-scrape-source-step
              (delete)="deleteAction(action)"
              *ngFor="let action of scrapeRequestFG.controls.actions.controls"
              [formGroup]="action"
            >
              <ion-col class="flex" size="10">
                <app-select
                  [formControl]="action.controls.type"
                  [items]="scrapeActionOptions"
                ></app-select>

                <!-- click -->
                <div
                  *ngIf="action.value.type === 'click'"
                  [formGroup]="action.controls.oneOf.controls.click"
                  class="flex"
                >
                  <app-select
                    [formControl]="
                      action.controls.oneOf.controls.click.controls.type
                    "
                    [items]="clickTypes"
                    placeholder="Choose Action"
                  >
                  </app-select>

                  <ng-container
                    *ngIf="action.value.oneOf.click.type === 'element'"
                  >
                    <ion-button
                      (click)="
                        triggerPickElement(
                          action.controls.oneOf.controls.click.controls.oneOf
                            .controls.element.controls.xpath.controls.value
                        )
                      "
                      [formGroup]="
                        action.controls.oneOf.controls.click.controls.oneOf
                          .controls.element.controls.xpath
                      "
                      color="light"
                      size="small"
                    >
                      {{
                        labelForXpath(
                          action.value.oneOf.click.oneOf.element.xpath.value
                        )
                      }}
                    </ion-button>
                  </ng-container>

                  <ng-container
                    *ngIf="action.value.oneOf.click.type === 'position'"
                  >
                    <ion-button
                      (click)="
                        triggerPickPosition(
                          action.controls.oneOf.controls.click.controls.oneOf
                            .controls.position
                        )
                      "
                      [formGroup]="
                        action.controls.oneOf.controls.click.controls.oneOf
                          .controls.position
                      "
                      color="light"
                      size="small"
                    >
                      {{
                        labelForPosition(
                          action.value.oneOf.click.oneOf.position
                        )
                      }}
                    </ion-button>
                  </ng-container>
                </div>

                <!-- delete -->
                <div
                  *ngIf="action.value.type === 'purge'"
                  [formGroup]="action.controls.oneOf.controls.purge"
                  class="flex"
                >
                  <ion-button
                    (click)="
                      triggerPickElement(
                        action.controls.oneOf.controls.purge.controls.value
                      )
                    "
                    [formControl]="
                      action.controls.oneOf.controls.purge.controls.value
                    "
                    color="light"
                    size="small"
                  >
                    {{ labelForXpath(action.value.oneOf.purge.value) }}
                  </ion-button>
                </div>

                <!-- cookie -->
                <div
                  *ngIf="action.value.type === 'cookie'"
                  [formGroup]="action.controls.oneOf.controls.cookie"
                  class="flex"
                >
                  <app-input
                    [formControl]="
                      action.controls.oneOf.controls.cookie.controls.value
                    "
                    placeholder="Set raw cookie string"
                    type="text"
                  ></app-input>
                </div>

                <!-- wait -->
                <div
                  *ngIf="action.value.type === 'wait'"
                  [formGroup]="action.controls.oneOf.controls.wait"
                  class="flex"
                >
                  <app-input
                    [formControl]="
                      action.controls.oneOf.controls.wait.controls.element
                        .controls.xpath.controls.value
                    "
                    placeholder="XPath"
                    type="text"
                  >
                  </app-input>
                  <ion-button
                    (click)="
                      triggerPickElement(
                        action.controls.oneOf.controls.wait.controls.element
                          .controls.xpath.controls.value
                      )
                    "
                    color="light"
                    size="small"
                  >
                    <ion-icon name="color-wand-outline"></ion-icon>
                  </ion-button>
                </div>

                <!-- type -->
                <!--                <div-->
                <!--                  class="flex"-->
                <!--                  [formGroup]="action.controls.oneOf.controls.type"-->
                <!--                  *ngIf="action.value.type === 'type'"-->
                <!--                >-->
                <!--                  <div class="flex">-->
                <!--                    <app-input-->
                <!--                      type="text"-->
                <!--                      placeholder="XPath"-->
                <!--                      [formControl]="-->
                <!--                        action.controls.oneOf.controls.type.controls.element-->
                <!--                          .controls.value-->
                <!--                      "-->
                <!--                    >-->
                <!--                    </app-input>-->

                <!--                    <ion-button-->
                <!--                      color="light"-->
                <!--                      size="small"-->
                <!--                      (click)="-->
                <!--                        triggerPickElement(-->
                <!--                          action.controls.oneOf.controls.type.controls.element-->
                <!--                            .controls.value-->
                <!--                        )-->
                <!--                      "-->
                <!--                    >-->
                <!--                      <ion-icon name="color-wand-outline"></ion-icon>-->
                <!--                    </ion-button>-->
                <!--                  </div>-->
                <!--                  <div class="flex">-->
                <!--                    <app-input-->
                <!--                      type="text"-->
                <!--                      placeholder="Type here"-->
                <!--                      [formControl]="-->
                <!--                        action.controls.oneOf.controls.type.controls.typeValue-->
                <!--                      "-->
                <!--                    >-->
                <!--                    </app-input>-->
                <!--                  </div>-->
                <!--                </div>-->

                <!-- select -->
                <!--                <div-->
                <!--                  class="flex"-->
                <!--                  [formGroup]="action.controls.oneOf.controls.select"-->
                <!--                  *ngIf="action.value.type === 'select'"-->
                <!--                >-->
                <!--                  <div class="flex">-->
                <!--                    <app-input-->
                <!--                      type="text"-->
                <!--                      [formControl]="-->
                <!--                        action.controls.oneOf.controls.select.controls.element-->
                <!--                          .controls.value-->
                <!--                      "-->
                <!--                      placeholder="XPath"-->
                <!--                    >-->
                <!--                    </app-input>-->
                <!--                    <ion-button-->
                <!--                      color="light"-->
                <!--                      size="small"-->
                <!--                      (click)="-->
                <!--                        triggerPickElement(-->
                <!--                          action.controls.oneOf.controls.select.controls.element-->
                <!--                            .controls.value-->
                <!--                        )-->
                <!--                      "-->
                <!--                    >-->
                <!--                      <ion-icon name="color-wand-outline"></ion-icon>-->
                <!--                    </ion-button>-->
                <!--                  </div>-->
                <!--                  <div class="flex">-->
                <!--                    <app-input-->
                <!--                      type="text"-->
                <!--                      placeholder="Value of Select"-->
                <!--                      [formControl]="-->
                <!--                        action.controls.oneOf.controls.select.controls-->
                <!--                          .selectValue-->
                <!--                      "-->
                <!--                    ></app-input>-->
                <!--                  </div>-->
                <!--                </div>-->

                <!-- header -->
                <div
                  *ngIf="action.value.type === 'header'"
                  [formGroup]="action.controls.oneOf.controls.header"
                  class="flex"
                >
                  <div class="flex">
                    <app-input
                      [formControl]="
                        action.controls.oneOf.controls.header.controls.name
                      "
                      placeholder="Set Header name"
                      type="text"
                    ></app-input>
                  </div>
                  <div class="flex">
                    <app-input
                      [formControl]="
                        action.controls.oneOf.controls.header.controls.value
                      "
                      placeholder="Set Header value"
                      type="text"
                    ></app-input>
                  </div>
                </div>
              </ion-col>
            </app-scrape-source-step>
            <ion-row>
              <ion-col size="10">
                <ion-button
                  (click)="addAction()"
                  [disabled]="
                    scrapeRequestFG.controls.actions.invalid ||
                    scrapeRequestFG.controls.url.invalid
                  "
                  color="light"
                  size="small"
                >
                  <ion-icon name="add-outline"></ion-icon>
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col
            (click)="logFormGroupStatus(mapperFg)"
            class="builder-label"
            size="2"
          >
            <span [ngClass]="{ error: mapperFg.invalid }">TRANSFORM</span>
          </ion-col>
          <ion-col [formGroup]="mapperFg" class="flex" size="10">
            <app-select
              *ngIf="mapperFg.value.type !== 'nativeFeed'"
              [formControl]="mapperFg.controls.type"
              [items]="getMapperOptions()"
              placeholder="Choose..."
            >
            </app-select>

            <ion-button
              *ngIf="mapperFg.value.type === 'nativeFeed'"
              [disabled]="true"
              color="light"
              >Native Feed
            </ion-button>

            <ng-container *ngIf="mapperFg.value.type === 'feed'">
              <ion-button
                (click)="triggerPickFeed(mapperFg.controls.oneOf.controls.feed)"
                [formControl]="mapperFg.controls.oneOf.controls.feed"
                color="light"
                size="small"
              >
                {{ labelForFeedMapper(mapperFg.controls.oneOf.controls.feed) }}
              </ion-button>
            </ng-container>

            <ng-container *ngIf="mapperFg.value.type === 'fragment'">
              <span class="label">BY</span>
              <!-- click -->
              <div class="flex">
                <app-select
                  [formControl]="
                    mapperFg.controls.oneOf.controls.fragment.controls
                      .fragmentType
                  "
                  [items]="fragmentTypes"
                >
                </app-select>

                <ng-container
                  *ngIf="
                    mapperFg.controls.oneOf.controls.fragment.value
                      .fragmentType === 'selector'
                  "
                >
                  <ion-button
                    (click)="
                      triggerPickElement(
                        mapperFg.controls.oneOf.controls.fragment.controls.oneOf
                          .controls.selector.controls.xpath
                      )
                    "
                    [formControl]="
                      mapperFg.controls.oneOf.controls.fragment.controls.oneOf
                        .controls.selector.controls.xpath
                    "
                    color="light"
                    size="small"
                  >
                    {{
                      labelForXpath(
                        mapperFg.controls.oneOf.controls.fragment.value.oneOf
                          .selector.xpath
                      )
                    }}
                  </ion-button>
                  <span class="label">INCLUDE</span>
                  <ion-button
                    (click)="
                      mapperFg.controls.oneOf.controls.fragment.controls.oneOf.controls.selector.controls.includeImage.setValue(
                        !mapperFg.value.oneOf.fragment.oneOf.selector
                          .includeImage
                      )
                    "
                    [color]="
                      mapperFg.value.oneOf.fragment.oneOf.selector.includeImage
                        ? 'success'
                        : 'dark'
                    "
                    fill="clear"
                  >
                    Screenshot
                  </ion-button>
                </ng-container>

                <ng-container
                  *ngIf="
                    mapperFg.controls.oneOf.controls.fragment.controls
                      .fragmentType.value === 'boundingBox'
                  "
                >
                  <ion-button
                    (click)="
                      triggerPickBoundingBox(
                        mapperFg.controls.oneOf.controls.fragment.controls.oneOf
                          .controls.boundingBox
                      )
                    "
                    [formGroup]="
                      mapperFg.controls.oneOf.controls.fragment.controls.oneOf
                        .controls.boundingBox
                    "
                    color="light"
                    size="small"
                  >
                    {{
                      labelForBoundingBox(
                        mapperFg.controls.oneOf.controls.fragment.controls.oneOf
                          .controls.boundingBox
                      )
                    }}
                  </ion-button>
                </ng-container>
              </div>
            </ng-container>
          </ion-col>
        </ion-row>
      </form>
    </div>
    <div class="flex flex__column">
      <div class="flex embedded-website flex__column">
        <div>
          <ion-toolbar *ngIf="!isPickAnyModeActive()">
            <div class="flex__row">
              <ion-segment
                [(ngModel)]="view"
                mode="ios"
                style="max-width: 400px"
              >
                <ion-segment-button *ngIf="embedMarkup" value="markup">
                  <ion-label>Markup</ion-label>
                </ion-segment-button>
                <ion-segment-button *ngIf="embedScreenshot" value="screenshot">
                  <ion-label>Screenshot</ion-label>
                </ion-segment-button>
                <ion-segment-button
                  *ngFor="let element of scrapedElements"
                  [value]="element.viewId"
                >
                  <ion-label>{{ element.label }}</ion-label>
                </ion-segment-button>
              </ion-segment>
              <div class="ion-margin-horizontal">
                <ion-note>{{ totalTime }}</ion-note>
              </div>
            </div>
          </ion-toolbar>

          <ion-toolbar *ngIf="isPickAnyModeActive()" color="primary">
            <p class="ion-margin-horizontal">{{ getPickModeLabel() }}</p>
            <ion-buttons slot="end">
              <ion-button (click)="resetPickMode()">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </div>

        <div *ngIf="errorMessage">
          <ion-note color="danger">{{ errorMessage }}</ion-note>
        </div>

        <div>
          <ion-progress-bar
            *ngIf="isLoading"
            type="indeterminate"
          ></ion-progress-bar>
        </div>

        <div
          *ngIf="!isLoading"
          [ngClass]="{ highlightFrame: isPickAnyModeActive() }"
          class="flex"
          style="position: relative; overflow-y: auto"
        >
          <div style="position: absolute; width: 100%">
            <app-embedded-website
              (pickedXpath)="handlePickedXpath($event)"
              *ngIf="view === 'markup'"
              [embed]="embedMarkup"
              [highlightXpath]="highlightXpath"
              [maxHeight]="true"
              [ngStyle]="{ display: view === 'markup' ? 'flex' : 'none' }"
              [showBoxes]="isDefined(pickElementDelegate)"
            ></app-embedded-website>
          </div>
          <app-embedded-image
            (pickedBoundingBox)="handlePickedBoundingBox($event)"
            (pickedPosition)="handlePickedPosition($event)"
            *ngIf="view === 'screenshot' && embedScreenshot"
            [embed]="embedScreenshot"
            [pickBoundingBox]="isDefined(pickBoundingBoxDelegate)"
            [pickPosition]="isDefined(pickPositionDelegate)"
          ></app-embedded-image>
          <div
            *ngIf="!['screenshot', 'markup'].includes(view)"
            [innerHtml]="getMarkupForDynamicView(view)"
            style="position: absolute"
          ></div>
        </div>
      </div>
    </div>
  </div>
</ion-content>
